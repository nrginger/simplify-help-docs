import pandas as pd
import requests
import json
import time
from tqdm import tqdm

# 1. Функция для обращения к локальному Ollama Mistral Instruct
def query_mistral(prompt, retry_count=0):
    url = "http://localhost:11434/api/generate"
    data = {
        "model": "mistral:instruct",
        "prompt": prompt,
        "stream": False
    }
    max_retries = 3
    try:
        resp = requests.post(url, json=data)
        if resp.status_code == 200:
            return resp.json().get("response", "").strip()
        else:
            if retry_count < max_retries:
                time.sleep(2)
                return query_mistral(prompt, retry_count+1)
            print(f"Error {resp.status_code}: {resp.text}")
    except Exception as e:
        if retry_count < max_retries:
            time.sleep(2)
            return query_mistral(prompt, retry_count+1)
        print(f"Exception: {e}")
    return ""

# 2. Читаем исходный Excel
INPUT_FILE  = "unique_texts_200_formatted_golden_standard.xlsx"
OUTPUT_FILE = "unique_texts_with_mistral.xlsx"
df = pd.read_excel(INPUT_FILE)

# 3. Подготовка шаблона промпта — вставьте сюда ваш готовый текст промпта
PROMPT_TEMPLATE = """
Ты - опытный технический писатель. Твоя специализация — улучшение пользовательской документации, руководств пользователя. Ты придерживаешься легкого инфостиля - информационного стиля. Тебя вдохновляют взгляды и работы Максима Ильяхова и Норы Галь - книга "Слово живое и мертвое". Выполняй правила ниже.
Попутно исправляй ошибки, которые возникли в результате распознавания PDF в TXT.

##Правила##
1. Делай:
   - Переписывай текст так, чтобы он стал простым и легким для восприятия.
   - Сохраняй технические термины и названия брендов без изменений.
   - Разделяй большие предложения на более короткие и четкие.
   - Заменяй причастия на конструкции "который + глагол", например "параметры, сохраняемые в памяти" --> "параметры, которые сохраняются в памяти".
   - Переделывай деепричастные обороты в новое предложение.
   - Обращайся к пользователю напрямую, используя "вы".
   - Применяй активный залог и добавляй больше глаголов для ясности.
   - Где возможно – заменяй существительные глаголами.
   - Соблюдай доброжелательный и поддерживающий tone of voice.
   - Если встречаешь символы, которые не имеют значения и не подходят по контексту – удаляй их.
   - Если видишь пробелы между словами, которых быть не должно – убирай пробелы.
   - Если в словах есть дефисы, которых быть не должно – убирай дефисы.
2. НЕ делай:
   - НЕ используй канцеляризмы, клише и манипулятивные фразы.
   - НЕ используй причастные и деепричастные обороты.
   - НЕ используй скобки и сложные синтаксические конструкции.
   - НЕ используй модальные слова, такие как "нужно", "можно", "необходимо", "следует" и другие подобные слова.
   - НЕ используй слова "данный" и "следующий", заменяй на конкретные указательные местоимения, например "этот", если они нужны.
   - НЕ используй слово "является", заменяй его на тире.
   - НЕ используй пассивные формы — выбирай активные и прямые конструкции.

##КОНТЕКСТ##
Тебе даны отрывки технической документации, которые нужно переработать в легкий и понятный стиль. Этот стиль должен соответствовать стандартам документации таких компаний, как Яндекс,Google, Microsoft, Apple. Тексты должны быть ясными и четкими, оставаясь в рамках технического домена, без перехода в разговорный стиль. Образцы переписанных фраз:
- Пример: "для настройки питания блока" --> "чтобы настроить питание блока".
- Пример: "Регулировка и настройка двигателя" --> "Как отрегулировать и настроить двигатель"
- Пример: "Выполните это для каждого устройства, изменяя положение переключателей согласно таблице." --> "Выполните это для каждого устройства. Изменяйте положение переключателей по таблице."
- Пример: "деталь является частью прибора" --> "деталь - это часть прибора"
- Пример: "связь, устанавливаемая" --> "связь, которая устанавливается"
- Пример: "при наличии заслонки" --> "если есть заслонка"
- Пример: "при эксплуатации холодильника" --> "когд вы используете холодильник"
- Пример: "производить проверку" --> "проверять"
- Пример: "осуществлять контроль" --> "контролировать"
- Пример: "выполнять работу" --> "работать"
- Пример: "совершать покупку" --> "покупать"
- Пример: "до момента открытия" --> "до того, как откроется"
Также учитывай, что инструкции были распознаны из PDF, поэтому они могут содержать артефакты: лишние символы, знаки препинания, неправильно распознанные слова. Исправляй такие недочеты.
Следуй этим инструкциям для достижения наиболее точного и эффективного результата. 

ВАЖНО: Не добавляй от себя никаких комментариев в начале и в конце переписанного текста.

Перепиши этот текст:

Текст: {text}

Переписанный текст:"""


# 4. Проходим по всем строкам и запрашиваем упрощение
results = []
for text in tqdm(df.iloc[:, 0].astype(str), desc="Simplifying"):
    if not text.strip():
        results.append("")  # пустая строка
    else:
        prompt = PROMPT_TEMPLATE.format(text=text)
        simplified = query_mistral(prompt)
        results.append(simplified)
        time.sleep(2)  # пауза между запросами

# 5. Сохраняем результаты в новый столбец и файл
df["mistral_instruct"] = results
df.to_excel(OUTPUT_FILE, index=False)

print(f"Готово! Сохранено в {OUTPUT_FILE}")
